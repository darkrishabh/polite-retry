<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Reference - Polite Retry</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="nav-logo">
        <span class="logo-icon">ü§ù</span>
        <span>Polite Retry</span>
      </a>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="guide.html">Guide</a>
        <a href="api.html" class="active">API</a>
        <a href="examples.html">Examples</a>
        <a href="https://github.com/darkrishabh/polite-retry" class="github-link" target="_blank">
          <svg height="20" width="20" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
          </svg>
          GitHub
        </a>
      </div>
    </div>
  </nav>

  <main class="container">
    <div class="docs-layout">
      <aside class="sidebar">
        <nav class="sidebar-nav">
          <h4>Functions</h4>
          <ul>
            <li><a href="#retry">retry()</a></li>
            <li><a href="#retryWithResult">retryWithResult()</a></li>
            <li><a href="#retryWithCircuitBreaker">retryWithCircuitBreaker()</a></li>
            <li><a href="#retryWithBudget">retryWithBudget()</a></li>
            <li><a href="#retryWithProtection">retryWithProtection()</a></li>
            <li><a href="#createRetryable">createRetryable()</a></li>
          </ul>
          <h4>Classes</h4>
          <ul>
            <li><a href="#CircuitBreaker">CircuitBreaker</a></li>
            <li><a href="#AdaptiveRetryBudget">AdaptiveRetryBudget</a></li>
            <li><a href="#BackpressureManager">BackpressureManager</a></li>
            <li><a href="#RequestCounter">RequestCounter</a></li>
          </ul>
          <h4>Utilities</h4>
          <ul>
            <li><a href="#calculateBackoff">calculateBackoff()</a></li>
            <li><a href="#createBackpressureMiddleware">createBackpressureMiddleware()</a></li>
          </ul>
          <h4>Types</h4>
          <ul>
            <li><a href="#RetryOptions">RetryOptions</a></li>
            <li><a href="#RetryResult">RetryResult</a></li>
            <li><a href="#RetryMetrics">RetryMetrics</a></li>
          </ul>
        </nav>
      </aside>

      <div class="api-content">
        <h1>API Reference</h1>
        <p>Complete API documentation for Polite Retry.</p>

        <h2>Functions</h2>

        <div class="api-section" id="retry">
          <h3>retry&lt;T&gt;(fn, options?): Promise&lt;T&gt;</h3>
          <p>Retry an async function with exponential backoff and jitter.</p>
          
          <h4>Parameters</h4>
          <table class="param-table">
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>Description</th>
            </tr>
            <tr>
              <td><code>fn</code></td>
              <td><code>() =&gt; Promise&lt;T&gt;</code></td>
              <td>The async function to retry</td>
            </tr>
            <tr>
              <td><code>options</code></td>
              <td><code>RetryOptions</code></td>
              <td>Optional configuration</td>
            </tr>
          </table>

          <h4>Returns</h4>
          <p><code>Promise&lt;T&gt;</code> - The result of the function, or throws the last error.</p>

          <h4>Example</h4>
          <div class="code-example">
            <pre><code class="language-typescript">const data = await retry(
  async () => fetch('/api/data').then(r => r.json()),
  { maxRetries: 3, jitter: 'full' }
);</code></pre>
          </div>
        </div>

        <div class="api-section" id="retryWithResult">
          <h3>retryWithResult&lt;T&gt;(fn, options?): Promise&lt;RetryResult&lt;T&gt;&gt;</h3>
          <p>Retry with detailed result information including attempt count and timing.</p>
          
          <h4>Returns</h4>
          <p><code>Promise&lt;RetryResult&lt;T&gt;&gt;</code> - Object with result, success flag, attempts, and timing.</p>

          <h4>Example</h4>
          <div class="code-example">
            <pre><code class="language-typescript">const { success, result, attempts, totalTimeMs } = await retryWithResult(
  async () => fetch('/api/data'),
  { maxRetries: 3 }
);

if (success) {
  console.log(`Got result in ${attempts} attempts (${totalTimeMs}ms)`);
} else {
  console.log(`Failed after ${attempts} attempts`);
}</code></pre>
          </div>
        </div>

        <div class="api-section" id="retryWithCircuitBreaker">
          <h3>retryWithCircuitBreaker&lt;T&gt;(fn, circuitBreaker, options?): Promise&lt;T&gt;</h3>
          <p>Retry with circuit breaker protection. Fails fast when circuit is open.</p>
          
          <h4>Parameters</h4>
          <table class="param-table">
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>Description</th>
            </tr>
            <tr>
              <td><code>fn</code></td>
              <td><code>() =&gt; Promise&lt;T&gt;</code></td>
              <td>The async function to retry</td>
            </tr>
            <tr>
              <td><code>circuitBreaker</code></td>
              <td><code>CircuitBreaker</code></td>
              <td>Circuit breaker instance</td>
            </tr>
            <tr>
              <td><code>options</code></td>
              <td><code>RetryOptions</code></td>
              <td>Optional configuration</td>
            </tr>
          </table>

          <h4>Throws</h4>
          <p><code>CircuitOpenError</code> when circuit is open.</p>
        </div>

        <div class="api-section" id="retryWithBudget">
          <h3>retryWithBudget&lt;T&gt;(fn, budget, options?): Promise&lt;T&gt;</h3>
          <p>Retry with Adaptive Retry Budgeting. Limits retry volume to prevent amplification.</p>
          
          <h4>Parameters</h4>
          <table class="param-table">
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>Description</th>
            </tr>
            <tr>
              <td><code>fn</code></td>
              <td><code>() =&gt; Promise&lt;T&gt;</code></td>
              <td>The async function to retry</td>
            </tr>
            <tr>
              <td><code>budget</code></td>
              <td><code>AdaptiveRetryBudget</code></td>
              <td>Budget manager instance</td>
            </tr>
            <tr>
              <td><code>options</code></td>
              <td><code>RetryOptions</code></td>
              <td>Optional configuration</td>
            </tr>
          </table>
        </div>

        <div class="api-section" id="retryWithProtection">
          <h3>retryWithProtection&lt;T&gt;(fn, protection, options?): Promise&lt;T&gt;</h3>
          <p>Retry with both circuit breaker AND adaptive budget protection.</p>
          
          <h4>Parameters</h4>
          <table class="param-table">
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>Description</th>
            </tr>
            <tr>
              <td><code>fn</code></td>
              <td><code>() =&gt; Promise&lt;T&gt;</code></td>
              <td>The async function to retry</td>
            </tr>
            <tr>
              <td><code>protection</code></td>
              <td><code>{ circuitBreaker, budget }</code></td>
              <td>Protection instances</td>
            </tr>
            <tr>
              <td><code>options</code></td>
              <td><code>RetryOptions</code></td>
              <td>Optional configuration</td>
            </tr>
          </table>

          <h4>Example</h4>
          <div class="code-example">
            <pre><code class="language-typescript">const breaker = new CircuitBreaker({ failureThreshold: 0.5 });
const budget = new AdaptiveRetryBudget({ initialBudget: 0.2 });

const result = await retryWithProtection(
  async () => criticalOperation(),
  { circuitBreaker: breaker, budget },
  { maxRetries: 3 }
);</code></pre>
          </div>
        </div>

        <div class="api-section" id="createRetryable">
          <h3>createRetryable&lt;TArgs, TResult&gt;(fn, options?)</h3>
          <p>Wrap a function to make it automatically retryable.</p>
          
          <h4>Example</h4>
          <div class="code-example">
            <pre><code class="language-typescript">const fetchUser = createRetryable(
  async (id: string) => {
    const res = await fetch(`/api/users/${id}`);
    return res.json();
  },
  { maxRetries: 3, jitter: 'full' }
);

// Use like a normal function
const user = await fetchUser('123');</code></pre>
          </div>
        </div>

        <h2>Classes</h2>

        <div class="api-section" id="CircuitBreaker">
          <h3>class CircuitBreaker</h3>
          <p>Implements the circuit breaker pattern to prevent requests to failing services.</p>
          
          <h4>Constructor Options</h4>
          <table class="param-table">
            <tr>
              <th>Option</th>
              <th>Type</th>
              <th>Default</th>
              <th>Description</th>
            </tr>
            <tr>
              <td><code>failureThreshold</code></td>
              <td><code>number</code></td>
              <td><code>0.5</code></td>
              <td>Failure rate to open circuit (0-1)</td>
            </tr>
            <tr>
              <td><code>windowSize</code></td>
              <td><code>number</code></td>
              <td><code>10</code></td>
              <td>Requests to consider for rate</td>
            </tr>
            <tr>
              <td><code>resetTimeoutMs</code></td>
              <td><code>number</code></td>
              <td><code>30000</code></td>
              <td>Time before testing recovery</td>
            </tr>
            <tr>
              <td><code>onStateChange</code></td>
              <td><code>function</code></td>
              <td>-</td>
              <td>Callback on state change</td>
            </tr>
          </table>

          <h4>Methods</h4>
          <table class="param-table">
            <tr>
              <th>Method</th>
              <th>Returns</th>
              <th>Description</th>
            </tr>
            <tr>
              <td><code>getState()</code></td>
              <td><code>CircuitState</code></td>
              <td>Get current state</td>
            </tr>
            <tr>
              <td><code>isAllowed()</code></td>
              <td><code>boolean</code></td>
              <td>Check if requests allowed</td>
            </tr>
            <tr>
              <td><code>recordSuccess()</code></td>
              <td><code>void</code></td>
              <td>Record successful request</td>
            </tr>
            <tr>
              <td><code>recordFailure()</code></td>
              <td><code>void</code></td>
              <td>Record failed request</td>
            </tr>
            <tr>
              <td><code>getFailureRate()</code></td>
              <td><code>number</code></td>
              <td>Current failure rate</td>
            </tr>
            <tr>
              <td><code>reset()</code></td>
              <td><code>void</code></td>
              <td>Reset to closed state</td>
            </tr>
          </table>
        </div>

        <div class="api-section" id="AdaptiveRetryBudget">
          <h3>class AdaptiveRetryBudget</h3>
          <p>Manages retry budget with adaptive adjustment based on failure rates.</p>
          
          <h4>Constructor Options</h4>
          <table class="param-table">
            <tr>
              <th>Option</th>
              <th>Type</th>
              <th>Default</th>
              <th>Description</th>
            </tr>
            <tr>
              <td><code>initialBudget</code></td>
              <td><code>number</code></td>
              <td><code>0.2</code></td>
              <td>Initial budget (0-1)</td>
            </tr>
            <tr>
              <td><code>budgetIncreaseRate</code></td>
              <td><code>number</code></td>
              <td><code>0.1</code></td>
              <td>Rate to increase budget</td>
            </tr>
            <tr>
              <td><code>budgetDecreaseRate</code></td>
              <td><code>number</code></td>
              <td><code>0.5</code></td>
              <td>Rate to decrease budget</td>
            </tr>
            <tr>
              <td><code>highFailureThreshold</code></td>
              <td><code>number</code></td>
              <td><code>0.3</code></td>
              <td>Threshold to decrease</td>
            </tr>
            <tr>
              <td><code>lowFailureThreshold</code></td>
              <td><code>number</code></td>
              <td><code>0.05</code></td>
              <td>Threshold to increase</td>
            </tr>
            <tr>
              <td><code>adjustmentIntervalMs</code></td>
              <td><code>number</code></td>
              <td><code>1000</code></td>
              <td>Budget adjustment interval</td>
            </tr>
            <tr>
              <td><code>onBudgetChange</code></td>
              <td><code>function</code></td>
              <td>-</td>
              <td>Callback on budget change</td>
            </tr>
            <tr>
              <td><code>checkBackpressure</code></td>
              <td><code>function</code></td>
              <td>-</td>
              <td>Backpressure check function</td>
            </tr>
          </table>

          <h4>Methods</h4>
          <table class="param-table">
            <tr>
              <th>Method</th>
              <th>Returns</th>
              <th>Description</th>
            </tr>
            <tr>
              <td><code>shouldRetry()</code></td>
              <td><code>Promise&lt;boolean&gt;</code></td>
              <td>Check if retry allowed</td>
            </tr>
            <tr>
              <td><code>shouldRetrySync()</code></td>
              <td><code>boolean</code></td>
              <td>Sync version (no backpressure)</td>
            </tr>
            <tr>
              <td><code>recordOutcome(success)</code></td>
              <td><code>void</code></td>
              <td>Record request outcome</td>
            </tr>
            <tr>
              <td><code>getBudget()</code></td>
              <td><code>number</code></td>
              <td>Current budget value</td>
            </tr>
            <tr>
              <td><code>getFailureRate()</code></td>
              <td><code>number</code></td>
              <td>Current failure rate</td>
            </tr>
            <tr>
              <td><code>getMetrics()</code></td>
              <td><code>RetryMetrics</code></td>
              <td>Get all metrics</td>
            </tr>
            <tr>
              <td><code>reset()</code></td>
              <td><code>void</code></td>
              <td>Reset to initial state</td>
            </tr>
            <tr>
              <td><code>dispose()</code></td>
              <td><code>void</code></td>
              <td>Clean up timers</td>
            </tr>
          </table>
        </div>

        <div class="api-section" id="BackpressureManager">
          <h3>class BackpressureManager</h3>
          <p>Tracks backpressure signals from downstream services.</p>
          
          <h4>Methods</h4>
          <table class="param-table">
            <tr>
              <th>Method</th>
              <th>Description</th>
            </tr>
            <tr>
              <td><code>recordSignal(serviceId, signal)</code></td>
              <td>Record a backpressure signal</td>
            </tr>
            <tr>
              <td><code>recordFromHeaders(serviceId, headers)</code></td>
              <td>Extract signal from HTTP headers</td>
            </tr>
            <tr>
              <td><code>isOverloaded(serviceId)</code></td>
              <td>Check if service is overloaded</td>
            </tr>
            <tr>
              <td><code>getLoadLevel(serviceId)</code></td>
              <td>Get current load level</td>
            </tr>
            <tr>
              <td><code>getRetryAfterMs(serviceId)</code></td>
              <td>Get suggested retry delay</td>
            </tr>
          </table>
        </div>

        <div class="api-section" id="RequestCounter">
          <h3>class RequestCounter</h3>
          <p>Tracks active concurrent requests for load calculation.</p>
          
          <h4>Methods</h4>
          <table class="param-table">
            <tr>
              <th>Method</th>
              <th>Description</th>
            </tr>
            <tr>
              <td><code>middleware()</code></td>
              <td>Express middleware that auto-tracks</td>
            </tr>
            <tr>
              <td><code>getCount()</code></td>
              <td>Current active request count</td>
            </tr>
            <tr>
              <td><code>increment()</code></td>
              <td>Manual increment</td>
            </tr>
            <tr>
              <td><code>decrement()</code></td>
              <td>Manual decrement</td>
            </tr>
          </table>
        </div>

        <h2>Types</h2>

        <div class="api-section" id="RetryOptions">
          <h3>interface RetryOptions</h3>
          <div class="code-example">
            <pre><code class="language-typescript">interface RetryOptions {
  maxRetries?: number;        // Default: 3
  initialDelayMs?: number;    // Default: 100
  maxDelayMs?: number;        // Default: 30000
  backoffMultiplier?: number; // Default: 2
  jitter?: 'none' | 'full' | 'equal' | 'decorrelated'; // Default: 'full'
  retryIf?: (error: Error) => boolean;
  onRetry?: (error: Error, attempt: number, delayMs: number) => void;
  timeoutMs?: number;
}</code></pre>
          </div>
        </div>

        <div class="api-section" id="RetryResult">
          <h3>interface RetryResult&lt;T&gt;</h3>
          <div class="code-example">
            <pre><code class="language-typescript">interface RetryResult&lt;T&gt; {
  result?: T;           // Successful result
  error?: Error;        // Final error if failed
  success: boolean;     // Whether succeeded
  attempts: number;     // Total attempts made
  totalTimeMs: number;  // Total time including delays
}</code></pre>
          </div>
        </div>

        <div class="api-section" id="RetryMetrics">
          <h3>interface RetryMetrics</h3>
          <div class="code-example">
            <pre><code class="language-typescript">interface RetryMetrics {
  totalRequests: number;
  successfulRequests: number;
  failedRequests: number;
  totalRetries: number;
  failureRate: number;
  retryAmplificationFactor: number;
}</code></pre>
          </div>
        </div>

      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <p>Created by <a href="https://github.com/darkrishabh">Rishabh Mehan</a> ‚Ä¢ MIT License</p>
    </div>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
</body>
</html>
